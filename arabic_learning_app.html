<!DOCTYPE html>
<html lang="ja" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ©ãƒ“ã‚¢èªå˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="stylesheet.css" type="text/css"
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸŒ™ ã‚¢ãƒ©ãƒ“ã‚¢èªå˜èªå­¦ç¿’</h1>
            <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å˜èªã‚’èª­ã¿è¾¼ã‚“ã§åŠ¹ç‡çš„ã«å­¦ç¿’</p>
        </header>

        <div class="file-upload-section">
            <h3>ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <div class="upload-instruction">
                <h4>CSVãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼:</h4>
                <p>ä»¥ä¸‹ã®åˆ—ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„:</p>
                <ul>
                    <li><code>No.</code> - ç•ªå·</li>
                    <li><code>ã‚¢ãƒ©ãƒ“ã‚¢èª</code> - ã‚¢ãƒ©ãƒ“ã‚¢èªã®å˜èª</li>
                    <li><code>å“è©</code> - å“è©ï¼ˆåè©ã€å‹•è©ãªã©ï¼‰</li>
                    <li><code>æ–‡æ³•æ€§ï¼ˆå˜æ•°å½¢ï¼‰</code> - ç”·æ€§ãƒ»å¥³æ€§ãªã©</li>
                    <li><code>å¥³æ€§å½¢</code> - å¥³æ€§å½¢ï¼ˆã‚ã‚Œã°ï¼‰</li>
                    <li><code>è¤‡æ•°å½¢</code> - è¤‡æ•°å½¢ï¼ˆã‚ã‚Œã°ï¼‰</li>
                    <li><code>æ„å‘³</code> - æ—¥æœ¬èªã®æ„å‘³</li>
                    <li><code>èª²</code> - èª²ç•ªå·</li>
                </ul>
            </div>
            <div class="file-input-wrapper">
                <input type="file" id="csvFileInput" class="file-input" accept=".csv" />
                <label for="csvFileInput" class="file-input-label">
                    ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </label>
            </div>
            <div id="fileStatus" class="file-status"></div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="studiedCount">0</div>
                <div>å­¦ç¿’æ¸ˆã¿</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="correctRate">0%</div>
                <div>æ­£ç­”ç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streak">0</div>
                <div>é€£ç¶šæ­£è§£</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalWords">0</div>
                <div>ç·å˜èªæ•°</div>
            </div>
        </div>

        <div class="category-selector hidden" id="categorySection">
            <h3>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h3>
            <div class="category-buttons" id="categoryButtons">
            </div>
        </div>

        <div class="card-container">
            <div id="welcomeCard" style="display: block;">
                <h2>ğŸ“š ã‚¢ãƒ©ãƒ“ã‚¢èªå˜èªå­¦ç¿’ã¸ã‚ˆã†ã“ãï¼</h2>
                <p style="font-size: 1.2em; margin: 20px 0; color: #7f8c8d;">
                    CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å­¦ç¿’ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                </p>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: #667eea;">âœ¨ æ©Ÿèƒ½ç´¹ä»‹</h4>
                    <ul style="text-align: left; margin: 15px 0;">
                        <li>ğŸ¯ å“è©ãƒ»èª²åˆ¥ã®å­¦ç¿’</li>
                        <li>ğŸ”Š éŸ³å£°ç™ºéŸ³æ©Ÿèƒ½</li>
                        <li>ğŸ“Š é€²æ—è¿½è·¡</li>
                        <li>ğŸ”„ åå¾©å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </li>
                        <li>ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³</li>
                    </ul>
                </div>
            </div>
            <div id="wordCard" style="display: none;">
                <div class="arabic-word" id="arabicWord">Ù…Ø±Ø­Ø¨Ø§</div>
                <div class="pronunciation" id="pronunciation">[mar-ha-ban]</div>
                <div class="word-info" id="wordInfo"></div>
                <div class="meaning" id="meaning" style="display: none;">ã“ã‚“ã«ã¡ã¯</div>
                
                <div class="controls">
                    <button class="btn btn-primary" id="playAudio">ğŸ”Š ç™ºéŸ³</button>
                    <button class="btn btn-success" id="showAnswer">ç­”ãˆã‚’è¦‹ã‚‹</button>
                    <button class="btn btn-success" id="correct" style="display: none;">âœ“ æ­£è§£</button>
                    <button class="btn btn-danger" id="incorrect" style="display: none;">âœ— ä¸æ­£è§£</button>
                    <button class="btn btn-warning" id="nextWord" style="display: none;">æ¬¡ã®å˜èª</button>
                </div>

                <div class="difficulty-indicators">
                    <div class="difficulty-dot easy"></div>
                    <div class="difficulty-dot medium"></div>
                    <div class="difficulty-dot hard"></div>
                </div>
            </div>
        </div>

        <div class="progress-section">
            <h3>ä»Šæ—¥ã®é€²æ—</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p id="progressText">0 / 10 å˜èªå®Œäº†</p>
        </div>
    </div>

    <div class="floating-feedback" id="feedback"></div>

    <script>
        // ã‚¢ãƒ©ãƒ“ã‚¢èªå˜èªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        let wordDatabase = {};
        let isDataLoaded = false;

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let currentCategory = null;
        let currentWordIndex = 0;
        let studiedWords = new Set();
        let correctAnswers = 0;
        let totalAnswers = 0;
        let currentStreak = 0;
        let showingAnswer = false;
        let dailyTarget = 10;
        let todayStudied = 0;

        // DOMè¦ç´ ã®å–å¾—
        const elements = {
            arabicWord: document.getElementById('arabicWord'),
            pronunciation: document.getElementById('pronunciation'),
            meaning: document.getElementById('meaning'),
            wordInfo: document.getElementById('wordInfo'),
            playAudio: document.getElementById('playAudio'),
            showAnswer: document.getElementById('showAnswer'),
            correct: document.getElementById('correct'),
            incorrect: document.getElementById('incorrect'),
            nextWord: document.getElementById('nextWord'),
            studiedCount: document.getElementById('studiedCount'),
            correctRate: document.getElementById('correctRate'),
            streak: document.getElementById('streak'),
            totalWords: document.getElementById('totalWords'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            feedback: document.getElementById('feedback'),
            csvFileInput: document.getElementById('csvFileInput'),
            fileStatus: document.getElementById('fileStatus'),
            categorySection: document.getElementById('categorySection'),
            categoryButtons: document.getElementById('categoryButtons'),
            welcomeCard: document.getElementById('welcomeCard'),
            wordCard: document.getElementById('wordCard')
        };

        // åˆæœŸåŒ–
        function init() {
            setupEventListeners();
            updateStats();
            updateProgress();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            elements.csvFileInput.addEventListener('change', handleFileUpload);

            // éŸ³å£°å†ç”Ÿ
            elements.playAudio.addEventListener('click', playAudio);

            // ç­”ãˆã‚’è¡¨ç¤º
            elements.showAnswer.addEventListener('click', showAnswer);

            // æ­£è§£ãƒ»ä¸æ­£è§£
            elements.correct.addEventListener('click', () => handleAnswer(true));
            elements.incorrect.addEventListener('click', () => handleAnswer(false));

            // æ¬¡ã®å˜èª
            elements.nextWord.addEventListener('click', loadRandomWord);
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            elements.fileStatus.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
            elements.fileStatus.className = 'file-status';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    parseCSV(csvText);
                } catch (error) {
                    showFileError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            reader.onerror = function() {
                showFileError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            };

            reader.readAsText(file, 'UTF-8');
        }

        // CSVè§£æ
        function parseCSV(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                }

                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // å¿…è¦ãªåˆ—ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                const requiredColumns = ['ã‚¢ãƒ©ãƒ“ã‚¢èª', 'æ„å‘³'];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    throw new Error(`å¿…è¦ãªåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missingColumns.join(', ')}`);
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
                const words = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVRow(lines[i]);
                    if (row.length < headers.length) continue;

                    const wordData = {};
                    headers.forEach((header, index) => {
                        wordData[header] = row[index] ? row[index].trim() : null;
                    });

                    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (wordData['ã‚¢ãƒ©ãƒ“ã‚¢èª'] && wordData['æ„å‘³']) {
                        words.push({
                            no: wordData['No.'] || i,
                            arabic: wordData['ã‚¢ãƒ©ãƒ“ã‚¢èª'],
                            partOfSpeech: wordData['å“è©'] || '',
                            gender: wordData['æ–‡æ³•æ€§ï¼ˆå˜æ•°å½¢ï¼‰'] || '',
                            feminine: wordData['å¥³æ€§å½¢'] || '',
                            plural: wordData['è¤‡æ•°å½¢'] || '',
                            meaning: wordData['æ„å‘³'],
                            lesson: parseInt(wordData['èª²']) || 1
                        });
                    }
                }

                if (words.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªå˜èªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ§‹ç¯‰
                buildWordDatabase(words);
                
                elements.fileStatus.textContent = `âœ… ${words.length}å€‹ã®å˜èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`;
                elements.fileStatus.className = 'file-status success';
                
                // UIã‚’æ›´æ–°
                isDataLoaded = true;
                elements.welcomeCard.style.display = 'none';
                elements.wordCard.style.display = 'block';
                elements.categorySection.classList.remove('hidden');
                
                setupCategories();
                updateStats();
                
            } catch (error) {
                showFileError(error.message);
            }
        }

        // CSVè¡Œã‚’è§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å¼•ç”¨ç¬¦å¯¾å¿œï¼‰
        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // å˜èªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ§‹ç¯‰
        function buildWordDatabase(words) {
            wordDatabase = {};
            
            words.forEach(word => {
                // å“è©åˆ¥ã‚«ãƒ†ã‚´ãƒª
                if (word.partOfSpeech) {
                    const posCategory = `å“è©_${word.partOfSpeech}`;
                    if (!wordDatabase[posCategory]) {
                        wordDatabase[posCategory] = [];
                    }
                    wordDatabase[posCategory].push(word);
                }

                // èª²åˆ¥ã‚«ãƒ†ã‚´ãƒª
                const lessonCategory = `èª²${word.lesson}`;
                if (!wordDatabase[lessonCategory]) {
                    wordDatabase[lessonCategory] = [];
                }
                wordDatabase[lessonCategory].push(word);

                // å…¨å˜èªã‚«ãƒ†ã‚´ãƒª
                if (!wordDatabase['å…¨å˜èª']) {
                    wordDatabase['å…¨å˜èª'] = [];
                }
                wordDatabase['å…¨å˜èª'].push(word);
            });
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã‚’è¨­å®š
        function setupCategories() {
            elements.categoryButtons.innerHTML = '';

            // ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆï¼ˆèª²ã‚’å„ªå…ˆã—ã¦è¡¨ç¤ºï¼‰
            const categories = Object.keys(wordDatabase).sort((a, b) => {
                if (a === 'å…¨å˜èª') return -1;
                if (b === 'å…¨å˜èª') return 1;
                if (a.startsWith('èª²') && b.startsWith('èª²')) {
                    return parseInt(a.replace('èª²', '')) - parseInt(b.replace('èª²', ''));
                }
                if (a.startsWith('èª²')) return -1;
                if (b.startsWith('èª²')) return 1;
                return a.localeCompare(b);
            });

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.dataset.category = category;
                
                // ã‚«ãƒ†ã‚´ãƒªåã‚’æ—¥æœ¬èªã§è¡¨ç¤º
                let displayName = category;
                if (category === 'å…¨å˜èª') {
                    displayName = `å…¨å˜èª (${wordDatabase[category].length})`;
                } else if (category.startsWith('èª²')) {
                    displayName = `${category} (${wordDatabase[category].length}èª)`;
                } else if (category.startsWith('å“è©_')) {
                    const pos = category.replace('å“è©_', '');
                    displayName = `${pos} (${wordDatabase[category].length}èª)`;
                }
                
                button.textContent = displayName;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = category;
                    loadRandomWord();
                });
                
                if (index === 0) {
                    button.classList.add('active');
                    currentCategory = category;
                }
                
                elements.categoryButtons.appendChild(button);
            });

            // æœ€åˆã®å˜èªã‚’èª­ã¿è¾¼ã¿
            if (currentCategory && wordDatabase[currentCategory]) {
                loadRandomWord();
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showFileError(message) {
            elements.fileStatus.textContent = 'âŒ ' + message;
            elements.fileStatus.className = 'file-status error';
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ãªå˜èªã‚’èª­ã¿è¾¼ã¿
        function loadRandomWord() {
            if (!isDataLoaded || !currentCategory || !wordDatabase[currentCategory]) {
                return;
            }

            const words = wordDatabase[currentCategory];
            if (words.length === 0) {
                showFileError('é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã«å˜èªãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            currentWordIndex = Math.floor(Math.random() * words.length);
            const word = words[currentWordIndex];

            elements.arabicWord.textContent = word.arabic;
            elements.meaning.textContent = word.meaning;
            elements.meaning.style.display = 'none';

            // å˜èªæƒ…å ±ã‚’è¡¨ç¤º
            let infoText = '';
            if (word.partOfSpeech) infoText += `å“è©: ${word.partOfSpeech}`;
            if (word.gender) infoText += ` | æ€§: ${word.gender}`;
            if (word.lesson) infoText += ` | èª²: ${word.lesson}`;
            if (word.plural) infoText += ` | è¤‡æ•°å½¢: ${word.plural}`;
            if (word.feminine) infoText += ` | å¥³æ€§å½¢: ${word.feminine}`;
            elements.wordInfo.textContent = infoText;

            // ç™ºéŸ³è¨˜å·ã¯æä¾›ã•ã‚Œã¦ã„ãªã„ã®ã§éè¡¨ç¤º
            elements.pronunciation.style.display = 'none';

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            elements.showAnswer.style.display = 'inline-block';
            elements.correct.style.display = 'none';
            elements.incorrect.style.display = 'none';
            elements.nextWord.style.display = 'none';
            showingAnswer = false;

            // é›£æ˜“åº¦è¡¨ç¤ºã®æ›´æ–°
            updateDifficultyIndicators();
        }

        // éŸ³å£°å†ç”Ÿï¼ˆWeb Speech APIä½¿ç”¨ï¼‰
        function playAudio() {
            if (!currentCategory || !wordDatabase[currentCategory]) return;
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(wordDatabase[currentCategory][currentWordIndex].arabic);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.7;
                speechSynthesis.speak(utterance);
            } else {
                showFeedback('éŸ³å£°æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'incorrect');
            }
        }

        // ç­”ãˆã‚’è¡¨ç¤º
        function showAnswer() {
            elements.meaning.style.display = 'block';
            elements.showAnswer.style.display = 'none';
            elements.correct.style.display = 'inline-block';
            elements.incorrect.style.display = 'inline-block';
            showingAnswer = true;
        }

        // å›ç­”å‡¦ç†
        function handleAnswer(isCorrect) {
            const wordKey = `${currentCategory}-${currentWordIndex}`;
            studiedWords.add(wordKey);
            totalAnswers++;

            if (isCorrect) {
                correctAnswers++;
                currentStreak++;
                todayStudied++;
                showFeedback('æ­£è§£ï¼', 'correct');
            } else {
                currentStreak = 0;
                showFeedback('ä¸æ­£è§£', 'incorrect');
            }

            elements.correct.style.display = 'none';
            elements.incorrect.style.display = 'none';
            elements.nextWord.style.display = 'inline-block';

            updateStats();
            updateProgress();
        }

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateStats() {
            elements.studiedCount.textContent = studiedWords.size;
            elements.correctRate.textContent = totalAnswers > 0 ? 
                Math.round((correctAnswers / totalAnswers) * 100) + '%' : '0%';
            elements.streak.textContent = currentStreak;
            
            // ç·å˜èªæ•°ã®è¨ˆç®—
            let totalWordCount = 0;
            if (wordDatabase && wordDatabase['å…¨å˜èª']) {
                totalWordCount = wordDatabase['å…¨å˜èª'].length;
            }
            elements.totalWords.textContent = totalWordCount;
        }

        // é€²æ—ã®æ›´æ–°
        function updateProgress() {
            const progressPercentage = Math.min((todayStudied / dailyTarget) * 100, 100);
            elements.progressFill.style.width = progressPercentage + '%';
            elements.progressText.textContent = `${todayStudied} / ${dailyTarget} å˜èªå®Œäº†`;
        }

        // é›£æ˜“åº¦è¡¨ç¤ºã®æ›´æ–°
        function updateDifficultyIndicators() {
            const dots = document.querySelectorAll('.difficulty-dot');
            dots.forEach(dot => {
                dot.className = 'difficulty-dot';
            });

            // ç°¡å˜ãªåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã«ã¯ã‚ˆã‚Šè¤‡é›‘ãªç®—å‡ºãŒå¯èƒ½ï¼‰
            const wordKey = `${currentCategory}-${currentWordIndex}`;
            if (studiedWords.has(wordKey)) {
                dots[0].classList.add('easy');
            } else {
                dots[2].classList.add('hard');
            }
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showFeedback(message, type) {
            elements.feedback.textContent = message;
            elements.feedback.className = `floating-feedback ${type} show`;
            
            setTimeout(() => {
                elements.feedback.classList.remove('show');
            }, 1500);
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        init();
    </script>
</body>
</html>